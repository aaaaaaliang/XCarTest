关键信号与名词

6D0 报文（上/下电指令）
上电：6D0 = 01 00 00 00 00 00 00 00
下电：6D0 = 04 00 00 00 00 00 00 00

795 保持唤醒报文：用于“保持清醒”以完成上电后的连通性验证。

四个外发报文：用于判断是否真正“静默/休眠”（你现网里是 0x5A0、0x603、0x6C0、0x6C1）。

电流阈值：

“唤醒活动阈值” >400 mA（达到后再去做 ping 验证）；大于400ma 开始可能ping通 需要假如重试机制


计时与窗口（重置规则很重要）

MQTT/物理按键映射周期：远端固定 60 分钟切换一次（上电/下电）。（这里是另一个物理按键脚本）

脚本不得自顾自跑固定时钟，而是每次收到 6D0 指令就“重置计时”：（yes）

合规窗口：从本次 6D0 到下一条 6D0 到来，理想 = 60 分钟，容错上限 70 分钟（1h10m）。

若 70 分钟内未见下一条 6D0，判 FAIL（超时未收到下一轮切换）；若 ≤60 分钟收到，判本项 PASS，并再次重置。
（假设70分钟 未收到 默认对面发了，但是我没收到 重置合理）

说明：这里“下一条 6D0”是指下一次切换（只有上电），用于验证远端周期是否按预期发生。脚本以实际收到为准，避免本地计时与远端误差。因为tbox会自己休眠

上电（6D0=01）后的一小时内必须完成的动作
并发开启本轮任务（收到 01 的此刻立即起新一轮计时；不用另起新的“额外 60 分钟线程”）：（但这里应该是70分钟吧 因为是70分钟内接收到下次下电信号）

电流监测：

上电后3 分钟内是否曾 >400 mA（记录时间戳与是否达标）。400ma只是两个cpu起来了，但是可能没完全起来
当监测到 >400 mA 时，判定“已充分唤醒”，进入连通性验证阶段。
795 保持唤醒：当电流首次 >400 mA 时开始发送 795，以保证设备在线期间完成连通性验证。
连通性（Ping）验证：
目标集合使用你“之前三类 ping 集合”（外部/主模组/副模组）那一套；
在电流 >400 mA 后开始尝试；

全部目标都要 PASS 才记为连通性 PASS（任一失败→本轮 FAIL）；

失败项要在日志中逐个点名（如 201/202 失败，需要明确列出并统计尝试次数、首通耗时等）。（减少了 类似很多无用日志的产生 不然 研究起来很累）

停止 795 并等待入睡：

当全部 ping 均通过后，立即停止 795；

统计 “停止 795 的时刻” 到 “最后一次看到那 4 个外发报文停止”的时间差；

休眠电流校验：自停止 795 起5 分钟内电流若降不下来（仍高于你设定的休眠判据，例如仍 >400 mA），则本轮 FAIL，无需再做“下一轮上电”的动作。
注：以上动作（电流监测、795 发送/停止、全套 ping、休眠判断）都必须在本轮 6D0=01 的 60 分钟窗口内完成，不要额外开启新的 60 分钟计时器。 需要在日志写明

下电（6D0=04）后的要求
主要用于验证远端周期性切换是否如期发生（即下一条 6D0 是否在 60 分钟内到来，70 分钟为超时红线）。

下电阶段通常不做连通性必过要求（设备可能休眠），但你可继续电流与四报文静默的被动监测，以完善统计。

判定逻辑（本轮结论 = AND 关系）

一轮“上电→验证→入睡”完整 PASS 需同时满足：

周期性切换合规：从上一条 6D0到本条 6D0到来在 ≤60 分钟（容错 ≤70 分钟）；

上电 3 分钟内曾 >300 mA（记录）；

电流 >400 mA 后完成全目标 ping 均 PASS（任一失败即本轮 FAIL，并逐项记录失败目标）；

停止 795 后 5 分钟内满足“休眠成立”（电流降到休眠阈值以下，且四个外发报文停止；记录停止时刻与时间差）；

日志完整（见下）。

若任何一条不满足，本轮 FAIL。失败的具体原因必须在日志中可读可追。

日志与统计（建议字段）

指令/计时：cycle_id, cmd(01/04), cmd_ts, window_deadline_ts(=cmd_ts+60m), hard_deadline_ts(=cmd_ts+70m), next_cmd_seen_ts, next_cmd_delta_s, window_pass(bool)

电流：gt300_within_3m(bool, ts), gt400_ts, max_ma_during_online, sleep_threshold_ma

795：send_795_on_ts, send_795_off_ts

连通性结果：

汇总：ping_all_pass(bool)

逐类：host_pass, main_pass, backup_pass

逐目标详细：first_ok_map{ip: seconds}, attempts_map{ip: cnt}, fail_list[ips]

入睡判据：last_four_frames_seen_ts, stop795_to_stop4frames_s, sleep_reached_within_5m(bool), sleep_judge_reason

最终结论：final_verdict(PASS/FAIL), fail_reasons[list], notes(json)

实施要点（避免踩坑）

以“收到 6D0”重置窗口，而非本地固定计时；

只在电流 >400 mA 后开始大量 ping，避免“半醒状态”误判；

连通性必须全通过，否则失败并给出精确失败清单；

停止 795 后再开始计 5 分钟休眠观察；

70 分钟是硬上限，用于防止远端与脚本时钟偏差导致的误杀/漏报。